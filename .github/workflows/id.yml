name: Generate RenPy 8+ Translation Template

on:
  workflow_dispatch:
    inputs:
      language_code:
        description: 'Language code (e.g., id, en, jp)'
        required: false
        default: 'id'

jobs:
  generate-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (Ren'Py requires Python 3.8+)
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Download Ren'Py 8.2.0 SDK
        run: |
          wget -q https://www.renpy.org/dl/8.2.0/renpy-8.2.0-sdk.tar.bz2
          tar -xf renpy-8.2.0-sdk.tar.bz2
          mv renpy-8.2.0-sdk renpy-sdk

      - name: Generate Translation Template (ignore error)
        run: |
          set +e
          LANG_CODE="${{ github.event.inputs.language_code || 'id' }}"
          cd renpy-sdk
          chmod +x renpy.sh
          ./renpy.sh ../game translate "$LANG_CODE" --extract
          EXITCODE=$?
          cd ..
          set -e

          if [ $EXITCODE -ne 0 ]; then
            echo "Ren'Py failed, will generate manual template block for all .rpy files."
            for src in $(find game -maxdepth 1 -name "*.rpy"); do
              fname=$(basename "$src" .rpy)
              mkdir -p "game/tl/$LANG_CODE"
              cat > "game/tl/$LANG_CODE/${fname}_tl.rpy" <<EOF
# translate $LANG_CODE strings for ${fname}.rpy generated manually
translate $LANG_CODE ${fname}_manual:
    # old "original text"
    # new "translation here"
EOF
            done
          fi

      - name: Upload Translation Templates
        uses: actions/upload-artifact@v4
        with:
          name: renpy-tl-template-${{ github.event.inputs.language_code || 'id' }}
          path: game/tl/${{ github.event.inputs.language_code || 'id' }}/