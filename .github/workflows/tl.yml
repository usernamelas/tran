name: Generate RenPy Translation Template

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      language_code:
        description: 'Language code (e.g., id, en, jp)'
        required: false
        default: 'id'

jobs:
  generate-template:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Project Structure
      run: |
        mkdir -p game
        cp tl/*.rpy game/
        echo "File yang akan di-generate template:"
        ls -l game/
        
    - name: Download Ren'Py SDK 8.0.3
      run: |
        wget -q https://www.renpy.org/dl/8.0.3/renpy-8.0.3-sdk.tar.bz2
        tar -xjf renpy-8.0.3-sdk.tar.bz2
        mv renpy-8.0.3-sdk renpy-sdk
        
    - name: Setup Python for Ren'Py
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Generate Translation Template
      run: |
        cd renpy-sdk
        
        # Use language from input or default to 'id'
        LANG_CODE="${{ github.event.inputs.language_code || 'id' }}"
        echo "Generating translation template for language: $LANG_CODE"
        
        # Generate template untuk bahasa yang dipilih
        python renpy.py ../. translate "$LANG_CODE" --extract
        
        echo "Files generated:"
        find .. -path "*/tl/$LANG_CODE/*" -name "*.rpy" -type f || echo "No tl/$LANG_CODE files found"
        find .. -path "*/game/tl/$LANG_CODE/*" -name "*.rpy" -type f || echo "No game/tl/$LANG_CODE files found"
        
    - name: Process and Rename Templates
      run: |
        LANG_CODE="${{ github.event.inputs.language_code || 'id' }}"
        mkdir -p "output/tl/$LANG_CODE"
        
        # Check multiple possible locations for generated files
        for search_path in "tl/$LANG_CODE" "game/tl/$LANG_CODE"; do
          if [ -d "$search_path" ]; then
            echo "Processing files from: $search_path"
            for file in $search_path/*.rpy; do
              if [ -f "$file" ]; then
                basename_file=$(basename "$file" .rpy)
                cp "$file" "output/tl/$LANG_CODE/${basename_file}_tl.rpy"
                echo "Created: ${basename_file}_tl.rpy"
              fi
            done
          fi
        done
        
        # If no files found, create empty template with instructions
        if [ ! "$(ls -A output/tl/$LANG_CODE 2>/dev/null)" ]; then
          echo "# No translatable content found or generation failed" > "output/tl/$LANG_CODE/README_tl.txt"
          echo "# Check your .rpy files contain dialogue, menus, or translatable text" >> "output/tl/$LANG_CODE/README_tl.txt"
          echo "# Language code used: $LANG_CODE" >> "output/tl/$LANG_CODE/README_tl.txt"
        fi
        
    - name: Show Results
      run: |
        LANG_CODE="${{ github.event.inputs.language_code || 'id' }}"
        echo "Generated translation templates for language: $LANG_CODE"
        ls -la "output/tl/$LANG_CODE/"
        
        echo -e "\nSample content:"
        for file in output/tl/$LANG_CODE/*.rpy; do
          if [ -f "$file" ]; then
            echo "=== $(basename $file) ==="
            head -15 "$file"
            echo ""
            break
          fi
        done
        
    - name: Upload Templates
      uses: actions/upload-artifact@v4
      with:
        name: renpy-translation-id-templates
        path: output/
        
    - name: Commit Generated Templates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/
        git diff --staged --quiet || git commit -m "Auto-generated Ren'Py translation templates for ID [skip ci]"
        git push || echo "Nothing new to commit"